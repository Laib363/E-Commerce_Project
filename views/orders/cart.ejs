<%- layout('layouts/boilerplate') -%>

<div class="row">
  <div class="col-lg-10 mx-auto cart-page">
    <h1 class="text-center my-4">My Shopping Cart</h1>

    <% if (currentUser && currentUser.cart && currentUser.cart.length > 0) { %>
      <% let totalAmount = 0; %>

      <div class="row gx-4 align-items-start">
        <!-- Left: cart items -->
        <div class="col-lg-8">
          <div class="card shadow-lg mb-4 items-card">
            <div class="card-body">
              <h4 class="card-title mb-4">Items in Cart</h4>

              <% currentUser.cart.forEach(item => { %>
                <% totalAmount += item.price; %>
                <div class="d-flex align-items-center mb-3 pb-3 border-bottom cart-item">
                  <img 
                    src="<%= item.image %>" 
                    alt="<%= item.title %>" 
                    class="rounded-3 me-3 product-thumb"
                  >
                  <div class="flex-grow-1 me-3 info-wrap">
                    <h5 class="mb-0 item-title"><%= item.title %></h5>
                    <p class="text-muted small mb-0 item-desc"><%= (item.description || '').substring(0, 80) %>...</p>
                  </div>

                  <div class="text-end me-3">
                    <h5 class="mb-0 text-danger">PKR <%= Number(item.price).toLocaleString("en-pk") %></h5>
                  </div>

                  <!-- Remove Button (Using method-override for DELETE) -->
                  <form action="/cart/remove/<%= item._id %>?_method=DELETE" method="POST" class="d-inline remove-form">
                    <input type="hidden" name="_method" value="DELETE">
                    <button type="submit" class="btn btn-outline-danger btn-sm remove-btn" title="Remove item">
                      <i class="fa-solid fa-trash-can"></i>
                    </button>
                  </form>
                </div>
              <% }); %>

            </div>
          </div>
        </div>

        <!-- Right: order summary -->
        <div class="col-lg-4 col-md-6">
          <div class="order-summary-wrapper">
            <div class="card shadow-lg mb-5 order-summary">
              <div class="card-body d-flex flex-column">
                <h4 class="card-title mb-3">Order Summary</h4>

                <div class="summary-row mb-2">
                  <div class="summary-label">Subtotal:</div>
                  <div class="summary-value">PKR <%= Number(totalAmount).toLocaleString("en-pk") %></div>
                </div>

                <div class="summary-row mb-3 border-bottom pb-3">
                  <div class="summary-label">Shipping:</div>
                  <div class="summary-value text-success">FREE</div>
                </div>

                <div class="summary-row mb-4 total-row">
                  <div class="summary-label"><h5 class="mb-0">Total:</h5></div>
                  <div class="summary-value"><h5 class="mb-0 text-danger">PKR <%= Number(totalAmount).toLocaleString("en-pk") %></h5></div>
                </div>

                <form action="/orders/checkout" method="POST" class="mt-auto">
                  <input type="hidden" name="totalAmount" value="<%= totalAmount %>">
                  <button type="submit" class="btn btn-primary checkout-btn">
                    Proceed to Checkout
                  </button>
                </form>
              </div>
            </div>
          </div>
        </div>

      </div>

    <% } else { %>
      <!-- Empty Cart -->
      <div class="card text-center my-5 shadow-lg empty-cart-card">
        <div class="card-body py-5">
          <i class="fa-solid fa-cart-shopping fa-3x text-muted mb-3"></i>
          <h4 class="card-title">Your cart is empty!</h4>
          <p class="card-text">Time to find some great products.</p>
          <a href="/listings" class="btn btn-dark mt-3">Start Shopping</a>
        </div>
      </div>
    <% } %>

  </div>
</div>